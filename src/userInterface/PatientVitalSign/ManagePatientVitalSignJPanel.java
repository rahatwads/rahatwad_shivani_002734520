/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package userInterface.PatientVitalSign;

import business.Person;
import business.PersonDirectory;
import business.VitalSign;
import business.VitalSignDirectory;
import java.awt.CardLayout;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.table.DefaultTableModel;
import userInterface.Person.CreatePatientVitalSIgnJPanel;
import userInterface.Person.ViewUpdateVitalSignsJPanel;

/**
 *
 * @author shivani
 */
public class ManagePatientVitalSignJPanel extends javax.swing.JPanel {

    /**
     * Creates new form ManagePatientVitalSignJPanel
     */
    
    
    private Person person;
    private PersonDirectory personDirectory;
    private JPanel userContainer;
    
    public ManagePatientVitalSignJPanel(JPanel userContainer,PersonDirectory personDirectory) {
        initComponents();
        this.personDirectory = personDirectory;
        this.userContainer = userContainer;
        populatePersonTable(personDirectory.getPersonDirectory());
    
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();
        viewPatientDetailsTable = new javax.swing.JTable();
        lblMngPersonTitle = new javax.swing.JLabel();
        jLabel1 = new javax.swing.JLabel();
        txtSearchPersonName = new javax.swing.JTextField();
        btnRefresh = new javax.swing.JButton();
        btnAddVitalSign = new javax.swing.JButton();
        btnDisplayVitalSignStatus = new javax.swing.JButton();
        jScrollPane2 = new javax.swing.JScrollPane();
        viewPatientVitalDetailsTable = new javax.swing.JTable();
        btnViewVitalSign = new javax.swing.JButton();
        tbnDeleteVitalSign = new javax.swing.JButton();
        tbnUpdateVitalSign = new javax.swing.JButton();
        btnAbnormalVitalSign = new javax.swing.JButton();
        jTextField1 = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        txtCountVitalSign = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();

        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        viewPatientDetailsTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null},
                {null, null, null, null, null}
            },
            new String [] {
                "Person Name", "Age", "Gender", "Patient Id", "Community"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane1.setViewportView(viewPatientDetailsTable);

        add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 117, 775, 178));

        lblMngPersonTitle.setFont(new java.awt.Font("Times New Roman", 1, 18)); // NOI18N
        lblMngPersonTitle.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblMngPersonTitle.setText("Manage Patient's Vital Signs");
        add(lblMngPersonTitle, new org.netbeans.lib.awtextra.AbsoluteConstraints(221, 6, 391, 37));

        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        jLabel1.setText("Search:");
        add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 76, 86, 29));

        txtSearchPersonName.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtSearchPersonNameActionPerformed(evt);
            }
        });
        add(txtSearchPersonName, new org.netbeans.lib.awtextra.AbsoluteConstraints(134, 76, 240, 29));

        btnRefresh.setText("Refresh");
        btnRefresh.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnRefreshActionPerformed(evt);
            }
        });
        add(btnRefresh, new org.netbeans.lib.awtextra.AbsoluteConstraints(679, 76, 104, 29));

        btnAddVitalSign.setText("Add Vital Signs");
        btnAddVitalSign.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAddVitalSignActionPerformed(evt);
            }
        });
        add(btnAddVitalSign, new org.netbeans.lib.awtextra.AbsoluteConstraints(381, 320, -1, 31));

        btnDisplayVitalSignStatus.setText("Display Patients Vital Sign Status");
        btnDisplayVitalSignStatus.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDisplayVitalSignStatusActionPerformed(evt);
            }
        });
        add(btnDisplayVitalSignStatus, new org.netbeans.lib.awtextra.AbsoluteConstraints(571, 320, -1, 31));

        viewPatientVitalDetailsTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {
                {null, null, null},
                {null, null, null},
                {null, null, null},
                {null, null, null}
            },
            new String [] {
                "Timestamp", "Status", "Community"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, false, false
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        jScrollPane2.setViewportView(viewPatientVitalDetailsTable);

        add(jScrollPane2, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 426, 584, 104));

        btnViewVitalSign.setText("View Vital Sign");
        btnViewVitalSign.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnViewVitalSignActionPerformed(evt);
            }
        });
        add(btnViewVitalSign, new org.netbeans.lib.awtextra.AbsoluteConstraints(191, 557, 110, 30));

        tbnDeleteVitalSign.setText("Delete Vital Sign");
        add(tbnDeleteVitalSign, new org.netbeans.lib.awtextra.AbsoluteConstraints(330, 557, 118, 30));

        tbnUpdateVitalSign.setText("Update Vital Sign");
        tbnUpdateVitalSign.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                tbnUpdateVitalSignActionPerformed(evt);
            }
        });
        add(tbnUpdateVitalSign, new org.netbeans.lib.awtextra.AbsoluteConstraints(475, 557, 129, 30));

        btnAbnormalVitalSign.setText("Count Abnormal Vital Sign");
        btnAbnormalVitalSign.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAbnormalVitalSignActionPerformed(evt);
            }
        });
        add(btnAbnormalVitalSign, new org.netbeans.lib.awtextra.AbsoluteConstraints(322, 701, -1, 30));
        add(jTextField1, new org.netbeans.lib.awtextra.AbsoluteConstraints(319, 629, 284, 30));

        jLabel2.setText("Enter community to find the count of Abnormal Cases :");
        add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 629, 281, 30));
        add(txtCountVitalSign, new org.netbeans.lib.awtextra.AbsoluteConstraints(509, 702, 103, 30));

        jLabel3.setIcon(new javax.swing.ImageIcon(getClass().getResource("/userInterface/PatientVitalSign/wp2610913.jpg"))); // NOI18N
        add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, -1, -1));
    }// </editor-fold>//GEN-END:initComponents

    private void txtSearchPersonNameActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtSearchPersonNameActionPerformed
        // TODO add your handling code here:

        String key= txtSearchPersonName.getText();
        if(key.length()==0)
        {
            JOptionPane.showMessageDialog(this, "Please enter key.",
                "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }
        ArrayList<Person> searchPersons;
        searchPersons=personDirectory.searchPerson(key);
        populatePersonTable(searchPersons);
    }//GEN-LAST:event_txtSearchPersonNameActionPerformed

    private void btnRefreshActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnRefreshActionPerformed
        // TODO add your handling code here:

        populatePersonTable(personDirectory.getPersonDirectory());
    }//GEN-LAST:event_btnRefreshActionPerformed

    private void btnAddVitalSignActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAddVitalSignActionPerformed
        // TODO add your handling code here:
        
        int selectedRow = viewPatientDetailsTable.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a row from table.",
                    "Error", JOptionPane.INFORMATION_MESSAGE);
            return;
        }
        Person person = (Person) viewPatientDetailsTable.getValueAt(selectedRow, 0);
        
        //JOptionPane.showMessageDialog(userContainer, person.getPersonId());
        //Patient patient= person.getPatient();
        if(person!=null)
        {
            CreatePatientVitalSIgnJPanel createPatientVitalSIgnJPanel = new CreatePatientVitalSIgnJPanel(userContainer, person);
            userContainer.add("createPatientVitalSIgnJPanel", createPatientVitalSIgnJPanel);
            CardLayout layout = (CardLayout) userContainer.getLayout();
            layout.next(userContainer);
        }
        else
        {
            JOptionPane.showMessageDialog(this, "Patient not created, Please create"
                    + " Patient first.", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }//GEN-LAST:event_btnAddVitalSignActionPerformed

    private void btnViewVitalSignActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnViewVitalSignActionPerformed
            // TODO add your handling code here:
            
        int selectedRow = viewPatientVitalDetailsTable.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a row from table.",
                    "Error", JOptionPane.INFORMATION_MESSAGE);
            return;
        }
        VitalSign vitalSign = (VitalSign) viewPatientVitalDetailsTable.getValueAt(selectedRow, 0);
        ViewUpdateVitalSignsJPanel viewUpdateVitalSignsJPanel = new ViewUpdateVitalSignsJPanel(userContainer,
                vitalSign, Boolean.FALSE);
        userContainer.add("viewUpdateVitalSignsJPanel", viewUpdateVitalSignsJPanel);
        CardLayout layout = (CardLayout) userContainer.getLayout();
        layout.next(userContainer);
    }//GEN-LAST:event_btnViewVitalSignActionPerformed

    private void btnDisplayVitalSignStatusActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDisplayVitalSignStatusActionPerformed
        // TODO add your handling code here:
        
        int selectedRow = viewPatientDetailsTable.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a row from table.",
                    "Error", JOptionPane.INFORMATION_MESSAGE);
            return;
        }
        Person person = (Person) viewPatientDetailsTable.getValueAt(selectedRow, 0);
        
        if(person!=null)
        {
            populateVitalSignTable(person);
        }
        else
        {
            JOptionPane.showMessageDialog(this, "Patient not created, Please create "
                    + "Patient first.", "Error", JOptionPane.ERROR_MESSAGE);
        }
    }//GEN-LAST:event_btnDisplayVitalSignStatusActionPerformed

    private void tbnUpdateVitalSignActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_tbnUpdateVitalSignActionPerformed
        // TODO add your handling code here:
        
         int selectedRow = viewPatientVitalDetailsTable.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Please select a row from table.",
                    "Error", JOptionPane.INFORMATION_MESSAGE);
            return;
        }
        VitalSign vitalSign = (VitalSign) viewPatientVitalDetailsTable.getValueAt(selectedRow, 0);
        
        ViewUpdateVitalSignsJPanel viewUpdateVitalSignsJPanel = new ViewUpdateVitalSignsJPanel(userContainer,
                vitalSign, Boolean.TRUE);
        userContainer.add("vuvsJPanel", viewUpdateVitalSignsJPanel);
        CardLayout layout = (CardLayout) userContainer.getLayout();
        layout.next(userContainer);
    }//GEN-LAST:event_tbnUpdateVitalSignActionPerformed

    private void btnAbnormalVitalSignActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAbnormalVitalSignActionPerformed
        // TODO add your handling code here:
        List<Person> peopleInGivenCommunity;
        peopleInGivenCommunity = personDirectory
        .getPersonDirectory().stream()
        .filter(p -> p.getCommunity().equals(jTextField1.getText()))
        .collect(Collectors.toList());
        int abnormalCount = 0;
        for(Person person: peopleInGivenCommunity){
            VitalSignDirectory vitalSignDirectory = person.getVitalSign();
            List<VitalSign> vitalSignLogs = vitalSignDirectory
            .getVitalSignDirectory();
            Collections.sort(vitalSignLogs, (a,b) -> b.getTimestamp()
                .compareTo(a.getTimestamp()));
            if(!vitalSignLogs.isEmpty()){
                VitalSign vSign = vitalSignLogs.get(0);
                String healthStatus = VitalSignStatus(person.getAge(),vSign);
                if(healthStatus.equals("Abnormal")){
                    abnormalCount++;
                }
            }

        }
        
        txtCountVitalSign.setText(String.valueOf(abnormalCount));
    }//GEN-LAST:event_btnAbnormalVitalSignActionPerformed

    private void populatePersonTable(ArrayList<Person> personsList) {
        DefaultTableModel model = (DefaultTableModel) viewPatientDetailsTable.getModel();
        model.setRowCount(0);
        if(personsList.isEmpty())
        {
            JOptionPane.showMessageDialog(this, "No Person's found. Please add"
                    + " Person's", "Warning", JOptionPane.INFORMATION_MESSAGE);
            return;
        }
        for (Person person : personsList) {
            Object[] row = new Object[5];
            row[0] = person;
            row[1]= person.getAge();
            row[2]= person.getGender();
            row[3]= person.getPersonId();
            row[4]=person.getCommunity();
           
            model.addRow(row);
        }
    }
    
    
    private void populateVitalSignTable(Person person) {
        
        DefaultTableModel model = (DefaultTableModel) viewPatientVitalDetailsTable.getModel();
        model.setRowCount(0);
        if (person != null) {
            int patientAge = person.getAge();
            ArrayList<VitalSign> vitalSignList = person.getVitalSign().getVitalSignDirectory();
            
            if (vitalSignList.isEmpty()) {
                JOptionPane.showMessageDialog(this, "No vital signs found. Please"
                        + " add vital signs", "Error", JOptionPane.INFORMATION_MESSAGE);
                return;
            }
            for (VitalSign vitalSign : vitalSignList) {
                Object[] row = new Object[3];
                row[0] = vitalSign;
                row[1] = VitalSignStatus(patientAge, vitalSign);
                row[2] =  person.getCommunity();
                model.addRow(row);
            }
        }
    }
    
//    private void populateAllVitalSigns() {
//        DefaultTableModel model = (DefaultTableModel) viewPatientVitalDetailsTable.getModel();
//        model.setRowCount(0);
//        ArrayList<VitalSign> vitalSignList = person.getVitalSign().getVitalSignDirectory();
//        JOptionPane.showMessageDialog(userContainer, vitalSignList);
//        int patientAge = person.getAge();
//        for (VitalSign vitalSign : vitalSignList) {
//              Object[] row = new Object[3];
//                row[0] = vitalSign;
//                row[1] = VitalSignStatus(patientAge, vitalSign);
//                row[2] =  person.getCommunity();
//                model.addRow(row);
//        }
//    }
//    
    
    private String VitalSignStatus(int patientAge, VitalSign vitalSign) {
        String vitalSignStatus = "Normal";
        
        double respirationRate = vitalSign.getRespiratoryRate();
        double heartRate = vitalSign.getHeartRate();
        double bloodPressure = vitalSign.getBloodPressure();
        double weight = vitalSign.getWeight();
        
        /*Toddler*/
        if (patientAge >= 1 && patientAge <= 3) {
            if ((respirationRate < 20 || respirationRate > 30) /*Respiration Rate*/
                    || (heartRate < 80 || heartRate > 130) /*Heart Rate*/
                    || (bloodPressure < 80 || bloodPressure > 110) /*Blood Pressure*/
                    || (weight < 22 || weight > 31)) /*Weight*/ {
                vitalSignStatus = "Abnormal";
            }
        }
        /*Preschooler*/
        if (patientAge >= 4 && patientAge <= 5) {
            if ((respirationRate < 20 || respirationRate > 30)
                    || (heartRate < 80 || heartRate > 120)
                    || (bloodPressure < 80 || bloodPressure > 110)
                    || (weight < 31 || weight > 40)) {
                vitalSignStatus = "Abnormal";
            }
        }
        /*School Age*/
        if (patientAge >= 6 && patientAge <= 12) {
            if ((respirationRate < 20 || respirationRate > 30)
                    || (heartRate < 70 || heartRate > 110)
                    || (bloodPressure < 80 || bloodPressure > 120)
                    || (weight < 41 || weight > 92)) {
                vitalSignStatus = "Abnormal";
            }
        }
        /*Adolescent*/
        if (patientAge >= 13) {
            if ((respirationRate < 12 || respirationRate > 20)
                    || (heartRate < 55 || heartRate > 105)
                    || (bloodPressure < 110 || bloodPressure > 120)
                    || (weight < 110)) {
                vitalSignStatus = "Abnormal";
            }
        }
        return vitalSignStatus;
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAbnormalVitalSign;
    private javax.swing.JButton btnAddVitalSign;
    private javax.swing.JButton btnDisplayVitalSignStatus;
    private javax.swing.JButton btnRefresh;
    private javax.swing.JButton btnViewVitalSign;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JTextField jTextField1;
    private javax.swing.JLabel lblMngPersonTitle;
    private javax.swing.JButton tbnDeleteVitalSign;
    private javax.swing.JButton tbnUpdateVitalSign;
    private javax.swing.JTextField txtCountVitalSign;
    private javax.swing.JTextField txtSearchPersonName;
    private javax.swing.JTable viewPatientDetailsTable;
    private javax.swing.JTable viewPatientVitalDetailsTable;
    // End of variables declaration//GEN-END:variables

    
}
